<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">

<!-- custom elements -->
<link rel="import" href="emsi-toolbar-desktop.html">
<link rel="import" href="emsi-toolbar-mobile.html">
<link rel="import" href="emsi-firebase-document.html">
<link rel="import" href="emsi-firebase-table.html">
<link rel="import" href="emsi-church-paper-card.html">
<link rel="import" href="emsi-church-collection.html">
<link rel="import" href="emsi-footer.html">

<!-- custom pages -->
<link rel="import" href="emsi-home-page.html">
<link rel="import" href="emsi-404-page.html">
<link rel="import" href="emsi-organization-page.html">
<link rel="import" href="emsi-beliefs-page.html">
<link rel="import" href="emsi-missions-page.html">
<link rel="import" href="emsi-seminary-page.html">
<link rel="import" href="emsi-search-page.html">
<link rel="import" href="emsi-ministries-page.html">
<link rel="import" href="emsi-churches-page.html">
<link rel="import" href="emsi-activities-page.html">
<link rel="import" href="emsi-courses-page.html">
<link rel="import" href="emsi-curriculum-page.html">
<link rel="import" href="emsi-signin-page.html">
<link rel="import" href="emsi-church-page.html">
<link rel="import" href="emsi-continent-page.html">

<!-- Define: emsi-app custom element -->
<!-- Usage: Used by index.html, runs the whole app in polymer context -->
<dom-module id="emsi-app">
  <template>
    <style is="custom-style">
      :host {
        display: block;
      }

      .mainContent {
        min-height: 100vh;
        background-color: white;
        position: absolute;
        z-index: -12;
        top:60pt;
        width: 100%;
      }
    </style>

    <!-- Register firebase element to bind to firebase project -->
    <firebase-app auth-domain="emsionline-2b9df.firebaseapp.com"
      database-url="https://emsionline-2b9df.firebaseio.com/"
      api-key="AIzaSyBWgbTxY5Oh2JonNkjJ9ZhTYgrRvg-D9gI">
    </firebase-app>

    <!-- app-location binds to the app's URL -->
    <app-location route="{{route}}" id="myRoute" query-params="{{queryParams}}"></app-location>

    <!-- this app-route manages the top-level routes -->
    <app-route
        route="{{route}}"
        pattern="/:page"
        data="{{routeData}}"
        tail="{{subroute}}"></app-route>

    <!-- set isDesktop property depending on width of screen -->
    <iron-media-query query="(min-width: 1000px)" query-matches="{{isDesktop}}"></iron-media-query>

    <template is="dom-if" if="[[isDesktop]]">
      <!-- Use emsi-toolbar-desktop for wide screens -->
      <emsi-toolbar-desktop> </emsi-toolbar-desktop>
    </template>
    <template is="dom-if" if="[[!isDesktop]]">
      <!-- Use emsi-toolbar-mobile for narrow screens -->
      <emsi-toolbar-mobile> </emsi-toolbar-mobile>
    </template>

    <div class="mainContent">    
      <!-- iron-pages selects the view based on the active route routeData.page by checking name of element, and show 404 image if no name matches -->
      <iron-pages selected="[[routeData.page]]" attr-for-selected="name" fallback-selection="404">
        <emsi-404-page class="page" name="404" lang="{{lang}}"> </emsi-404-page>
        <emsi-home-page class="page" name="" lang="{{lang}}"> </emsi-home-page>
        <emsi-home-page class="page"name="home" lang="{{lang}}"> </emsi-home-page>
        <emsi-organization-page class="page" name="about" lang="{{lang}}"> </emsi-organization-page>
        <emsi-beliefs-page class="page" name="beliefs" lang="{{lang}}"> </emsi-beliefs-page>
        <emsi-missions-page class="page" name="missions" lang="{{lang}}"> </emsi-missions-page>
        <emsi-seminary-page class="page" name="seminary" lang="{{lang}}"> </emsi-seminary-page>
        <emsi-search-page class="page" name="search" lang="{{lang}}"> </emsi-search-page>
        <emsi-continent-page class="page" name="america" lang="{{lang}}" continent="America"> </emsi-continent-page>
        <emsi-continent-page class="page" name="europe" lang="{{lang}}" continent="Europe"> </emsi-continent-page>
        <emsi-continent-page class="page" name="asia" lang="{{lang}}" continent="Asia"> </emsi-continent-page>
        <emsi-continent-page class="page" name="africa" lang="{{lang}}" continent="Africa"> </emsi-continent-page>
        <emsi-ministries-page class="page" name="ministries" lang="{{lang}}"> </emsi-ministries-page>
        <emsi-churches-page class="page" name="churches" lang="{{lang}}"> </emsi-churches-page>
        <emsi-activities-page class="page" name="activities" lang="{{lang}}"> </emsi-activities-page>
        <emsi-courses-page class="page" name="courses" lang="{{lang}}"> </emsi-courses-page>
        <emsi-curriculum-page class="page" name="curriculum" lang="{{lang}}"> </emsi-curriculum-page>
        <emsi-signin-page class="page" name="signin" lang="{{lang}}"> </emsi-signin-page>
        <emsi-church-page id="churchPage" class="page" name="church" lang="{{lang}}" path="{{route.path}}"> </emsi-church-page>
      </iron-pages>

      <!-- Footer -->
      <emsi-footer lang="{{lang}}"> </emsi-footer>
    </div>

  </template>

  <script>
    Polymer({

      is: 'emsi-app',

      // lang property binded to each page element
      properties: {
        lang: {
          type: String,
          value: "en",
        }
      } ,

      // Listen to route and lang change events from all polymer elements
      listeners: {
        'emsi-route-change-event': 'routeChangeEventHandler',
        'emsi-lang-change-event': 'langChangeEventHandler',
      },

      // Called on event fired, emsi-route-change-event, given object param
      routeChangeEventHandler: function(e, param) {
        console.log("Route Change Event Handler: " + param.route);

        // Set all pages back to the top of the screen
        this.scrollAllPagesToTop();

        this.set('route.path', param.route);
        this.$.churchPage.path = this.route.path;
      },

      // Called on event fired, emsi-lang-change-event, given object param
      langChangeEventHandler: function(e, param) {
        console.log("Lang Change Event Handler: " + param.lang);

        // Set top level lang to language, this will cascade down each page binded to lang {{lang}}
        this.lang = param.lang;

        // Change queryParams to reflect lang change
        if(param.lang == "en") {
          this.$.myRoute.queryParams = {lang: "en"};
        } else if(param.lang == "zh") {
          this.$.myRoute.queryParams = {lang: "zh"};
        }
      },

      // Set all pages back to the top of the screen
      scrollAllPagesToTop: function() {
        setTimeout(function(){this.document.body.scrollTop = 0;}, 0);
      },

      attached: function() {
        // Set language to english or chinese on load given queryParams
        if(this.$.myRoute.queryParams.lang == undefined || this.$.myRoute.queryParams.lang == "en") {
          this.lang = "en";
        } else if(this.$.myRoute.queryParams.lang == "zh") {
          this.lang = "zh";
        }

        console.log("Language set to: " + this.lang);
      }

    });
  </script>
</dom-module>
