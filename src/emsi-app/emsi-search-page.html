<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">

<dom-module id="emsi-search-page">
	<template>
		<style>
			:host {
				display: block;
				color: black;
				height: 80vh;
			}

			paper-spinner-lite {
				padding-left: 45%;
				height: 50px;
				width: 50px;
				padding-top: 100px;
			}

			#backgroundImage {
				position: absolute;
				height: 81vh;
				width: 100%;
				z-index: -1;
				top: 0px;
			}
		</style>

		<firebase-document
	      path= "locations"
	      data="{{data}}">
	    </firebase-document>

		<iron-image id="backgroundImage" style="background-color: black;" sizing="cover" preload src="../FindALocationBkgrd-01.jpg"></iron-image>

		<div> Showing the emsi-search-page </div>
		<br>
		<div> Search by Address </div>
		<paper-input id="addressBox" always-float-label label="Address" placeholder="36 Alpine Road, Towaco, NJ"></paper-input>
		<paper-button raised on-tap="startSearchByAddress"> Search </paper-button>
		or
		<paper-button raised on-tap="getLocation"> Use Your Location </paper-button>
		<br>

		<template is="dom-repeat" id="addrFinder" items="[[dataArr]]">
			<iron-collapse class="collapse">
	        	<emsi-church-paper-card city="{{item.name}}" address="{{item.address}}" sunday-service-time="{{item.time}}" learn-more-url="{{item.name}}" user-location="{{address}}" on-distance-updated="distanceUpdated"> </emsi-church-paper-card>
	        <iron-collapse>
	    </template>

		<template is="dom-repeat" id="churchdisplay" items="[[displayArr]]">
	        	<emsi-church-paper-card city="{{item.name}}" address="{{item.address}}" sunday-service-time="{{item.time}}" learn-more-url="{{item.name}}" user-distance-text="{{item.distance}}"> </emsi-church-paper-card>
	    </template>

		<template is="dom-if" if="[[isSearching]]">
	      <paper-spinner-lite active class="thick"></paper-spinner-lite>
	    </template>

	</template>
	<script>
		Polymer({
			is: 'emsi-search-page',

			properties: {
				lang: {
					type: String,
					value: "en"
				} ,
				address: String ,
				data: {
					type: Object,
					value: {},
					observer: "dataChanged"
				},
				dataArr: {
					type: Array,
					value: []
				} , 
				directionsArr: {
					type: Array,
					value: []
				} ,
				displayArr: {
					type: Array,
					value: []
				},
				isSearching: Boolean ,
				maxCount: {
					type: Number,
					value: 5
				}
			} ,

			distanceUpdated: function(params) {
				if(params.detail.distance.text == undefined) return;
				this.push("directionsArr", params.detail);
				console.log(params.detail);
			} ,

			dataChanged: function(newValue, oldValue) {
				if(oldValue == undefined) return;
				if(JSON.stringify(newValue) == JSON.stringify(oldValue)) return;

				this.set("dataArr", []);

				for(var key in newValue) {
					this.push("dataArr", newValue[key]);
				}
			} ,

			resetDataArr: function() {
				this.set("dataArr", []);
				
				for(var key in this.data) {
					this.push("dataArr", this.data[key]);
				}

				console.log(this.dataArr);
			} ,

			startSearchByAddress: function() {
				if(this.$.addressBox.value == "") return;
				if(this.isSearching == true) return;

				this.resetDataArr();

				this.address = "";
				this.address = this.$.addressBox.value;
				this.set("directionsArr", []);
				this.set("displayArr", []);
				this.isSearching = true;

				this.startSearch();
			} ,

			startSearch: function() {
				setTimeout(function(){
					this.directionsArr.sort(function(a, b){return a.distance.value-b.distance.value});

					console.log(this.directionsArr);

					var currCount = 0;

					for(var i = 0; i < this.directionsArr.length; i++) {
						for(var key in this.dataArr) {
							if(this.dataArr[key].name == this.directionsArr[i].name) {
								if(currCount >= this.maxCount) break;
								currCount++;

								this.push("displayArr", this.dataArr[key]);
								this.dataArr[key].distance = this.directionsArr[i].distance.text;
							}
						}
					}

					this.isSearching = false;
				}.bind(this), 4000);
			} ,


			attached: function() {
				
			} ,

			toggleAllCollapse: function() {
				var collapseArr = Polymer.dom(this.root).querySelectorAll('.collapse');
				for(var i = 0; i < collapseArr.length; i++) {
					collapseArr[i].show();
				}
			} ,

			getLocation: function() {
				if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(function(position){
						if(this.isSearching == true) return;

						this.address = "";
						this.address = position.coords.latitude + " " + position.coords.longitude;
						this.resetDataArr();
						this.$.addrFinder.render();
						this.set("directionsArr", []);
						this.set("displayArr", []);
						this.isSearching = true;

						this.startSearch();
					}.bind(this));
				}
			} ,

		});
	</script>
</dom-module>